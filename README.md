# EtherCATパケット解析ビューア

## 概要
このツールは、PCAPNGファイルからEtherCATパケットを読み込み、解析して表示するためのビューアです。EtherCATプロトコルの詳細な情報を視覚的に確認することができます。

## 機能
- PCAPNGファイルからのEtherCATパケット読み込み
- 事前フィルタリング機能（Wireshark表示フィルタ形式）
- 後処理フィルタリング機能（表示データの絞り込み）
- パケット詳細情報の表示（基本情報、EtherCAT情報、16進データ）
- CSVおよびExcelへのエクスポート機能
- ET2000タイムスタンプの解析
- パケット間の時間差表示
- ボード定義管理機能（ログアドレスからボード名を自動判別）

## 必要条件
- Python 3.6以上
- 必要パッケージ：
  - pandas
  - pyshark
  - matplotlib
  - tkinter
  - openpyxl

## インストール方法
1. 必要なパッケージをインストールします：
```
pip install -r requirements.txt
```

2. tkinterがインストールされていない場合は、システムに応じてインストールしてください。

## 使用方法
1. 以下のコマンドでアプリケーションを起動します：
```
python 16_improved_filter_stats.py
```

2. 「PCAPNGファイルを選択」ボタンをクリックして解析するファイルを選択します。
3. 必要に応じてフィルタを設定し、パケット情報を確認します。

## ボード定義管理機能
### 概要
ログアドレスからボードタイプを自動的に判別する機能です。C言語のヘッダーファイル（.h）から#define定義を読み込み、アドレスとボード名のマッピングを作成します。

### 使用方法
1. 「ボード定義管理」ボタンをクリックします
2. 「ヘッダーファイルを読み込む」ボタンでmciom01.hやctmxmlvalue.hなどのヘッダーファイルを選択します
3. 定義が自動的に解析され、ボード名とアドレスの対応表が表示されます
4. 「定義を保存」ボタンで解析結果をJSONファイルに保存できます
5. 保存した定義は次回起動時に自動的に読み込まれます

### 表示例
- ログアドレス「00080000」→「MA0_PROT04_00_S(00080000)」のように表示されます
- Info欄では「LRW@MA0_SAFETY」のようにコマンドとボード名が併記されます

## ライセンス
このソフトウェアは内部使用を目的としています。

## 特定条件のスループット計算
以下の条件に一致するパケットのスループットを自動計算します：
- MACアドレスが「02:」で始まる（送信元または宛先）
- EtherCATパケット内のすべてのデータグラムのコマンドが0x04および0x05以外

この計算では、パケット内のすべてのEtherCATデータグラム（#1, #2, #3...）をチェックし、
いずれかのデータグラムのコマンドが0x04または0x05の場合、そのパケット全体を除外します。

## ファイル構成
- `16_improved_filter_stats.py`: メインプログラム
- `config.py`: 設定ファイル
- `data_utils.py`: データ処理ユーティリティ
- `error_handler.py`: エラー処理モジュール
- `ui_settings.json`: UI設定ファイル
- `board_definition_parser.py`: ボード定義解析モジュール
- `board_definition_dialog.py`: ボード定義管理ダイアログ
- `board_definitions.json`: 保存されたボード定義（自動生成）
- `sample_board_definitions.h`: ヘッダーファイルのサンプル

## 注意事項
- 大量のパケットを含むPCAPNGファイルを開く場合は、処理に時間がかかることがあります
- 特定条件のスループット計算は、該当するパケットが存在する場合のみ表示されます
- ボード定義機能を使用するには、board_definition_parser.pyとboard_definition_dialog.pyが必要です

## トラブルシューティング
### ボード定義機能が使用できない場合
- board_definition_parser.pyとboard_definition_dialog.pyが同じディレクトリにあることを確認してください
- ファイルが存在しない場合でも、基本機能は使用可能です（ボード名表示のみ無効）

### Excelエクスポートエラーが発生する場合
- openpyxlパッケージがインストールされているか確認してください：
```
pip install openpyxl
```