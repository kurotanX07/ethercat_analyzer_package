# EtherCATパケット解析ビューア

## 概要
このツールは、PCAPNGファイルからEtherCATパケットを読み込み、解析して表示するためのビューアです。EtherCATプロトコルの詳細な情報を視覚的に確認することができます。

## 機能
- PCAPNGファイルからのEtherCATパケット読み込み
- 事前フィルタリング機能（Wireshark表示フィルタ形式）
- 後処理フィルタリング機能（表示データの絞り込み）
- パケット詳細情報の表示（基本情報、EtherCAT情報、16進データ）
- CSVおよびExcelへのエクスポート機能
- ET2000タイムスタンプの解析
- パケット間の時間差表示
- ボード定義管理機能（ログアドレスからボード名を自動判別）
- 周期分析機能（パケット間隔の統計分析）
- データフロー解析機能（データのやり取りを可視化）

## 必要条件
- Python 3.6以上
- 必要パッケージ：
  - pandas
  - pyshark
  - matplotlib
  - tkinter
  - openpyxl
  - networkx

## インストール方法
1. 必要なパッケージをインストールします：
```
pip install -r requirements.txt
```

2. tkinterがインストールされていない場合は、システムに応じてインストールしてください。

## 使用方法
1. 以下のコマンドでアプリケーションを起動します：
```
python 16_improved_filter_stats.py
```

2. 「PCAPNGファイルを選択」ボタンをクリックして解析するファイルを選択します。
3. 必要に応じてフィルタを設定し、パケット情報を確認します。

## ボード定義管理機能
### 概要
ログアドレスからボードタイプを自動的に判別する機能です。C言語のヘッダーファイル（.h）から#define定義を読み込み、アドレスとボード名のマッピングを作成します。

### 使用方法
1. 「ボード定義管理」ボタンをクリックします
2. 「ヘッダーファイルを読み込む」ボタンでmciom01.hやctmxmlvalue.hなどのヘッダーファイルを選択します
3. 定義が自動的に解析され、ボード名とアドレスの対応表が表示されます
4. 「定義を保存」ボタンで解析結果をJSONファイルに保存できます
5. 保存した定義は次回起動時に自動的に読み込まれます

### 表示例
- ログアドレス「00080000」→「MA0_PROT04_00_S(00080000)」のように表示されます
- Info欄では「LRW@MA0_SAFETY」のようにコマンドとボード名が併記されます

## 周期分析機能
### 概要
パケット間の時間差を分析し、通信の周期性や安定性を評価する機能です。

### 使用方法
1. PCAPNGファイルを読み込む
2. 「周期分析」ボタンをクリック
3. 分析対象を選択：
   - 全パケット
   - Source MACアドレス別
   - EtherCAT Cmd別
   - LogAddr別
4. グラフで時間差の推移と分布を確認

## データ解析機能
### 概要
EtherCATネットワーク内のデータのやり取りを詳細に分析する機能です。

### 機能詳細
1. **通信マトリックス**: ノード間の通信頻度をヒートマップで表示
2. **データフロー**: ネットワークグラフでデータの流れを可視化
3. **時系列通信ビュー**: 時間軸とLogAddrで通信状態を可視化
   - 通信の有無を時系列で表示
   - 周期異常やRound Trip異常を色分けで表示
   - ホバーで詳細情報表示、クリックで詳細ウィンドウ表示
4. **コマンド・レスポンス**: コマンドの使用統計とWorking Counter分析
5. **データペイロード**: 特定LogAddrのデータ変化を追跡
6. **エラー分析**: タイムアウトや異常値を検出
7. **サマリー**: 全体的な通信統計を表示

### 使用方法
1. PCAPNGファイルを読み込む
2. 「データ解析」ボタンをクリック
3. 各タブで異なる観点からデータを分析

## ライセンス
このソフトウェアは内部使用を目的としています。

## 特定条件のスループット計算
以下の条件に一致するパケットのスループットを自動計算します：
- MACアドレスが「02:」で始まる（送信元または宛先）
- EtherCATパケット内のすべてのデータグラムのコマンドが0x04および0x05以外

この計算では、パケット内のすべてのEtherCATデータグラム（#1, #2, #3...）をチェックし、
いずれかのデータグラムのコマンドが0x04または0x05の場合、そのパケット全体を除外します。

## ファイル構成
- `16_improved_filter_stats.py`: メインプログラム
- `config.py`: 設定ファイル
- `data_utils.py`: データ処理ユーティリティ
- `error_handler.py`: エラー処理モジュール
- `ui_settings.json`: UI設定ファイル
- `board_definition_parser.py`: ボード定義解析モジュール
- `board_definition_dialog.py`: ボード定義管理ダイアログ
- `data_flow_analyzer.py`: データフロー解析モジュール
- `board_definitions.json`: 保存されたボード定義（自動生成）
- `sample_board_definitions.h`: ヘッダーファイルのサンプル

## 注意事項
- 大量のパケットを含むPCAPNGファイルを開く場合は、処理に時間がかかることがあります
- 特定条件のスループット計算は、該当するパケットが存在する場合のみ表示されます
- ボード定義機能を使用するには、board_definition_parser.pyとboard_definition_dialog.pyが必要です

## トラブルシューティング
### ボード定義機能が使用できない場合
- board_definition_parser.pyとboard_definition_dialog.pyが同じディレクトリにあることを確認してください
- ファイルが存在しない場合でも、基本機能は使用可能です（ボード名表示のみ無効）

### Excelエクスポートエラーが発生する場合
- openpyxlパッケージがインストールされているか確認してください：
```
pip install openpyxl
```